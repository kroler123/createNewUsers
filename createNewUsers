#!groovy
// Check properties
properties([disableConcurrentBuilds()])

pipeline {
        agent {
                label 'master'
        }
        parameters {

		string(name: 'login', defaultValue: 'null', description: 'Введите логин')

		string(name: 'fName', defaultValue: 'null', description: 'Введите имя')

		string(name: 'sName', defaultValue: 'null', description: 'Введите фамилию')

		choice(name: 'ou', choices: ['Salon Admins','Salon Users'],description: 'Выберите права')

		booleanParam(name: 'GroupRD',defaultValue: true, description: 'Использовать группу удалённого доступа?')

		booleanParam(name: 'GroupAdmin',defaultValue: false, description: 'Использовать группу Администратор?')

	}
        options {
                buildDiscarder(logRotator(numToKeepStr: '10', artifactNumToKeepStr: '10'))
                timestamps()
                skipStagesAfterUnstable()
                disableConcurrentBuilds()
        }
	stages {
                stage("Скачиваем базу в файл") {
                        steps {
                                script {
                                        sh (script: 'mysql -h 192.168.102.2 -u kalinkin -p159753 -Bse "SELECT Domain_Controller FROM rbt WHERE virtual = \'proxmox\' AND Domain_Controller" -D RBT > DB',label: 'Download DB in the file \"DB\"')
                                }
                        }
                }
		stage("Чтение файла") {
			steps {
				script {
					sh (script: '''#!/bin/bash
							while read line 
							do 
							echo $line
							test=`fping "$line"`
							echo $test
							if [ "$test" == "$line is alive" ];then
								echo "login - $login , OU = $ou , Name = $fName $sName , Group = $GroupRD $GroupAdmin"
								ssh -o 'StrictHostKeyChecking no' root@"$line" '/usr/local/samba/bin/samba-tool user create $login Test1234 --userou="OU=$ou" --given-name=$fName --surname=$sName'
							if [ "$GroupRD" == true ]; then
								ssh -o 'StrictHostKeyChecking no' root@"$line" /usr/local/samba/bin/samba-tool group addmembers "Remote Desktop Users" $login	
							fi
							if [ "$GroupAdmin" == true ]; then
								ssh -o 'StrictHostKeyChecking no' root@"$line" /usr/local/samba/bin/samba-tool group addmembers "Domain Admins" $login	
							fi
							fi
							done < DB
							echo "test - $SALON"
							''',label: 'Чтение из файла')
//					sh (script: 'while read line; do ssh -o \'StrictHostKeyChecking no\' root@"$line" ip a < /dev/null ; done < DB',label: 'Чтение из файла')
				}
			}
		}
	}
}
